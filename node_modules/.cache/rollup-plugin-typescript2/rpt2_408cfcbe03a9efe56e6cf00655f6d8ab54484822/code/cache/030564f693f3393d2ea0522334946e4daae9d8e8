{"code":"// effect1(()=>{\r\n//     state.name\r\n//     effect2(()=>{\r\n//         state.age;\r\n//     })\r\n//     state.address\r\n// })\r\n// // effectStack = [effect1] activeEffect = effect1\r\n// // effect1 -> name\r\n// // effect2 -> age\r\n// // effect1 -> address\r\nlet effectStack = []; // 目的就是为了能保证我们effect执行的时候 可以存储正确的关系\r\nlet activeEffect;\r\nfunction cleanupEffect(effect) {\r\n    const { deps } = effect;\r\n    for (let dep of deps) {\r\n        // set 删除effect 让属性 删除掉对应的effect   name = []\r\n        dep.delete(effect); // 让属性对应的effect移除掉，这样属性更新的时候 就不会触发这个effect重新执行了\r\n    }\r\n}\r\n// 属性变化 触发的是 dep -> effect\r\n// effect.deps = [] 和属性是没关系的\r\nexport class ReactiveEffect {\r\n    constructor(fn, scheduler) {\r\n        this.fn = fn;\r\n        this.scheduler = scheduler;\r\n        this.active = true; // this.active = true;\r\n        this.deps = []; // 让effect 记录他依赖了哪些属性 ， 同时要记录当前属性依赖了哪个effect\r\n    }\r\n    run() {\r\n        if (!this.active) { // 稍后如果非激活状态 调用run方法 默认会执行fn函数\r\n            return this.fn();\r\n        }\r\n        if (!effectStack.includes(this)) { // 屏蔽同一个effect会多次执行\r\n            try {\r\n                effectStack.push(activeEffect = this);\r\n                return this.fn(); // 取值  new Proxy 会执行get方法  (依赖收集)\r\n            }\r\n            finally {\r\n                effectStack.pop(); // 删除最后一个\r\n                activeEffect = effectStack[effectStack.length - 1];\r\n            }\r\n        }\r\n    }\r\n    stop() {\r\n        if (this.active) {\r\n            cleanupEffect(this);\r\n            this.active = false;\r\n        }\r\n    }\r\n}\r\n// obj name :[effect]\r\n//     age : [effect]\r\n// {对象：{属性 ： [effect,effect]}  } \r\nexport function isTracking() {\r\n    return activeEffect !== undefined;\r\n}\r\nconst targetMap = new WeakMap();\r\nexport function track(target, key) {\r\n    // 是只要取值我就要收集吗？\r\n    if (!isTracking()) { // 如果这个属性 不依赖于effect直接跳出即可\r\n        return;\r\n    }\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap) {\r\n        targetMap.set(target, (depsMap = new Map())); // {对象：map{}}\r\n    }\r\n    let dep = depsMap.get(key);\r\n    if (!dep) {\r\n        depsMap.set(key, (dep = new Set())); // {对象：map{name:set[]}}\r\n    }\r\n    trackEffects(dep);\r\n}\r\nexport function trackEffects(dep) {\r\n    let shouldTrack = !dep.has(activeEffect); // 看一下这个属性有没有存过这个effect\r\n    if (shouldTrack) {\r\n        dep.add(activeEffect); // // {对象：map{name:set[effect,effect]}}\r\n        activeEffect.deps.push(dep); // 稍后用到\r\n    } // { 对象：{name:set,age:set}\r\n}\r\nexport function trigger(target, key) {\r\n    let depsMap = targetMap.get(target);\r\n    if (!depsMap)\r\n        return; // 属性修改的属性 根本没有依赖任何的effect\r\n    let deps = []; // [set ,set ]\r\n    if (key !== undefined) {\r\n        deps.push(depsMap.get(key));\r\n    }\r\n    let effects = [];\r\n    for (const dep of deps) {\r\n        effects.push(...dep);\r\n    }\r\n    triggerEffects(effects);\r\n}\r\nexport function triggerEffects(dep) {\r\n    for (const effect of dep) { // 如果当前effect执行 和 要执行的effect是同一个，不要执行了 防止循环\r\n        if (effect !== activeEffect) {\r\n            if (effect.scheduler) {\r\n                return effect.scheduler();\r\n            }\r\n            effect.run(); // 执行effect\r\n        }\r\n    }\r\n}\r\nexport function effect(fn) {\r\n    const _effect = new ReactiveEffect(fn);\r\n    _effect.run(); // 会默认让fn执行一次\r\n    let runner = _effect.run.bind(_effect);\r\n    runner.effect = _effect; // 给runner添加一个effect实现 就是 effect实例\r\n    return runner;\r\n}\r\n// vue3 的响应式原理  取值时 收集对应的effect， 改值时找到对应的effect执行\r\n//# sourceMappingURL=effect.js.map","references":[],"map":"{\"version\":3,\"file\":\"effect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/effect.ts\"],\"names\":[],\"mappings\":\"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\"}"}
